# Story 1.2: Refactor `SearchService` for PubMed Logic & Session Management

**Status:** Review

## Goal & Context

**User Story:** As a developer, I want the `SearchService` in `services.py` to correctly manage all business logic for PubMed searches, including API interaction and database session lifecycle, using architecturally sound interfaces, so that search operations are reliable, maintainable, and adhere to the service layer pattern defined in `docs/api-reference.md`.

**Context:** This story is a critical part of Epic 1 ("Search and Service Layer Stabilization"). It focuses on refactoring the `SearchService` to be the single point of responsibility for PubMed search operations. This includes encapsulating PubMed API interactions, managing database sessions internally for its methods, and ensuring it correctly uses the `SearchResultRepository` (Story 1.3) and relevant Pydantic schemas like `schemas.SearchResultUpdate` (Story 1.5) and `schemas.SystematicReviewCreate`/`Update` (Story 2.1). This refactoring is essential for a stable and maintainable search functionality and for the correct operation of dependent components like `search.py` (Story 1.1).

## Detailed Requirements

(Copied from `docs/epic1-recovery-search-stabilization.md#Story-1.2`)

1.  **Encapsulate PubMed API Interaction:** `SearchService` must implement the `search_pubmed_and_store_results` method. This method will:
    *   Accept `review_id`, `query`, and `max_results`.
    *   Internally handle all aspects of querying the PubMed API (e.g., using BioPython Entrez or a similar HTTP client mechanism).
    *   Fetch raw results from PubMed.
    *   Utilize the internal `_map_pubmed_to_search_result` method to transform raw PubMed records into `models.SearchResult` instances.
    *   Ensure `SearchResult` instances are correctly populated (e.g., `source_db='PubMed'`, `source_id=PMID`, `year` as `str | None`).
    *   Store these `SearchResult` instances using `SearchResultRepository.add_all` (or similar batch method).
2.  **Session Management:**
    *   All public methods in `SearchService` (including the new `search_pubmed_and_store_results`, `get_search_results_by_review_id`, `get_search_result_by_source_details`, `update_search_result`, `delete_search_result`) MUST manage their own database sessions internally (e.g., using `with self.session_factory() as session:`). The `session: Session | None` parameter MUST be removed from all public method signatures.
    *   The internally managed session MUST be passed to any `SearchResultRepository` methods called.
3.  **Update Method Signature and Logic:**
    *   The `update_search_result` method signature MUST be changed from `(self, result_update: models.SearchResult, ...)` to `(self, result_id: uuid.UUID, update_data: schemas.SearchResultUpdate, ...)` as per `docs/api-reference.md`. Internally, it will fetch the `SearchResult` by `result_id`, apply updates from `update_data`, and save.
4.  **Method Removal:**
    *   The existing `add_api_search_results` method MUST be removed. Its functionality is superseded by the properly encapsulated `search_pubmed_and_store_results`.
5.  **Internal Mapping Methods:**
    *   Ensure `_map_pubmed_to_search_result` and `_map_scopus_to_search_result` have correct type hints (`api_record: dict[str, Any]`).
    *   Verify mapping logic aligns with `models.SearchResult` (e.g., `year` as `str | None`). The linter error regarding `year` being `int` in the mapper vs `str` in the model needs to be resolved by ensuring the mapper provides a string.
6.  **Error Handling:** Implement robust error handling for PubMed API interactions and database operations within the service methods.
7.  **Linter Errors:** Resolve all linter errors within the `SearchService` code block in `services.py` after refactoring.
8.  **`ReviewService` Session Management:**
    *   All public methods in `ReviewService` (`create_review`, `get_review`, `get_all_reviews`, `update_review`, `delete_review`) MUST manage their own database sessions internally. The `session: Session | None` parameter MUST be removed from their public signatures.
    *   The internally managed session MUST be passed to any `SystematicReviewRepository` methods called.

## Acceptance Criteria (ACs)

(Copied from `docs/epic1-recovery-search-stabilization.md#Story-1.2`)

- AC1: `SearchService.search_pubmed_and_store_results` is implemented, encapsulates PubMed search, mapping, and storage logic, and returns a sequence of `models.SearchResult`.
- AC2: All public methods in `SearchService` manage sessions internally and no longer accept a `session` parameter.
- AC3: `SearchService.update_search_result` signature and implementation are updated to use `result_id` and `schemas.SearchResultUpdate`.
- AC4: `SearchService.add_api_search_results` method is removed.
- AC5: `SearchService` uses `SearchResultRepository` for all database interactions related to `SearchResult` objects, passing an internally managed session.
- AC6: `_map_pubmed_to_search_result` correctly maps PubMed data to `models.SearchResult`, including `year` as `str | None`.
- AC7: Linter errors in `services.py` related to `SearchService` are resolved.
- AC8: Unit test coverage for `SearchService` (mocking repository and PubMed API calls) achieves >80%.
- AC9: Relevant integration tests for PubMed search functionality via `SearchService` pass.
- AC10: All public methods in `ReviewService` manage sessions internally and no longer accept a `session` parameter.
- AC11: `ReviewService` uses `SystematicReviewRepository` for all database interactions related to `SystematicReview` objects, passing an internally managed session.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**
  - Files to Modify: `src/sr_assistant/app/services.py` (for `SearchService` and `ReviewService` refactoring)
  - Files to Modify: `src/sr_assistant/app/pages/protocol.py` (to align `ReviewService` calls)

- **Key Technologies:**
  - Python, SQLModel, SQLAlchemy (for session management)
  - Pydantic (for `schemas.SearchResultUpdate`, `schemas.SystematicReviewCreate`, `schemas.SystematicReviewUpdate`)
  - BioPython Entrez (or equivalent for PubMed API interaction)

- **API Interactions / SDK Usage:**
  - PubMed API (via Entrez or HTTP client)
  - Internal `SearchResultRepository` API (methods from Story 1.3)
  - Internal `SystematicReviewRepository` API

- **Data Structures & Model Definitions:**
  - `models.SearchResult` (from `src/sr_assistant/core/models.py`)
  - `schemas.SearchResultUpdate` (from `src/sr_assistant/core/schemas.py` - Story 1.5)
  - `schemas.SystematicReviewCreate` (from `src/sr_assistant/core/schemas.py` - Story 2.1)
  - `schemas.SystematicReviewUpdate` (from `src/sr_assistant/core/schemas.py` - Story 2.1)
  - `docs/api-reference.md#SearchService` and `docs/api-reference.md#ReviewService` for target method signatures.

- **Environment Variables:**
  - `NCBI_API_KEY` (if direct Entrez usage requires it and it's not already handled by a config module). Check existing PubMed interaction logic.

- **Coding Standards Notes:**
  - Internal session management pattern:
    ```python
    from sqlalchemy.orm import sessionmaker # SQLModel uses Session from sqlmodel, not orm
    from sqlmodel import Session # Correct import for SQLModel session
    from sr_assistant.app.database import session_factory as app_main_session_factory # Example import for the app's factory

    # In service __init__
    class YourService:
        def __init__(self, factory: sessionmaker[Session] = app_main_session_factory, other_dependencies...):
            self.session_factory: sessionmaker[Session] = factory
            # self.repo = other_dependencies.repo etc.
    
        # In service method
        def some_method(self, ...):
            with self.session_factory() as session: # session will be of type sqlmodel.Session
                # Perform operations with session
                # repo_result = self.repository.some_method(session, ...)
                session.commit() # Or handle transaction as needed (e.g. for writes)
                # return repo_result
    ```
  - Ensure `_map_pubmed_to_search_result` correctly handles potential missing fields from API records to prevent errors when populating `models.SearchResult`, especially for optional fields like `year`.
  - `year` in `models.SearchResult` should be `str | None`. The mapping function must ensure this.

- **Project Structure Alignment:**
  - All service logic resides in `src/sr_assistant/app/services.py`.

## Testing Requirements

**Guidance:** Verify implementation against the ACs. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:** (in `tests/unit/app/test_services.py`)
  - **`SearchService`:**
    - Test `search_pubmed_and_store_results`:
      - Mock PubMed API call (e.g., `Entrez.efetch`, `Entrez.esearch`).
      - Mock `_map_pubmed_to_search_result`.
      - Mock `SearchResultRepository.add_all` (or equivalent batch add method from Story 1.3).
      - Verify internal session management (mock `session_factory`, check `begin`, `commit`/`rollback`, `close` calls).
      - Verify correct parameters passed to mocks.
      - Test error handling for API failures and repository failures.
    - Test `update_search_result`:
      - Mock `SearchResultRepository.get_by_id` and `SearchResultRepository.update`.
      - Verify that data from `schemas.SearchResultUpdate` is correctly applied to the fetched `models.SearchResult` instance before `update` is called.
      - Verify internal session management.
    - Test other public methods (`get_search_results_by_review_id`, `get_search_result_by_source_details`, `delete_search_result`) for correct session passing to repository mocks.
    - Test `_map_pubmed_to_search_result`:
      - Provide sample raw PubMed API records (as dicts).
      - Verify correct mapping to `models.SearchResult`, especially for `source_db`, `source_id`, `title`, `abstract`, and `year` (as `str | None`). Handle cases where fields might be missing in the API response.
    - Test that input Pydantic schemas (`SystematicReviewCreate`, `SystematicReviewUpdate`) are handled correctly.
  - **`ReviewService`:**
    - For each public method (`create_review`, `get_review`, `get_all_reviews`, `update_review`, `delete_review`):
      - Mock the corresponding `SystematicReviewRepository` method.
      - Verify internal session management (mock `session_factory`, check `begin`, `commit`/`rollback`, `close` calls).
      - Verify correct parameters passed to repository mocks.
      - Test that input Pydantic schemas (`SystematicReviewCreate`, `SystematicReviewUpdate`) are handled correctly.
- **Integration Tests:**
  - Consider a TDD-like approach, potentially starting with an integration test for each key service method, then elaborating with unit tests.
  - Integration tests for PubMed search functionality (AC9) will involve actual API calls to PubMed (consider rate limiting, using a test API key if available, and testing with small `max_results`). These tests should verify that `SearchService.search_pubmed_and_store_results` correctly fetches, maps, and stores data in the integration test database.
  - Integration tests for `ReviewService` methods will verify interactions with the actual database.

## Tasks / Subtasks

(Derived from `docs/epic1-recovery-search-stabilization.md#Story-1.2` and expanded)

- [X] **Task 1.2.1: Refactor `SearchService` Public Methods for Internal Session Management**
  - [X] Modify `SearchService.__init__` to accept an injectable `factory: sessionmaker[Session]` parameter (e.g., `from sr_assistant.app.database import session_factory as app_main_session_factory; ... __init__(self, factory: sessionmaker[Session] = app_main_session_factory, search_repo: SearchResultRepository | None = None, ...)`). Store it as `self.session_factory`.
  - [X] For `get_search_results_by_review_id`: Remove `session` param, implement internal session using `self.session_factory.begin()`, pass session to repo.
  - [X] For `get_search_result_by_source_details`: Remove `session` param, implement internal session using `self.session_factory.begin()`, pass session to repo.
  - [X] For `delete_search_result`: Remove `session` param, implement internal session using `self.session_factory.begin()`, pass session to repo.
- [X] **Task 1.2.2: Implement `search_pubmed_and_store_results` Method in `SearchService`**
  - [X] Define method signature: `(self, review_id: uuid.UUID, query: str, max_results: int = 100) -> Sequence[models.SearchResult]`.
  - [X] Implement internal session management using `self.session_factory.begin()`.
  - [X] Integrate PubMed API call logic (e.g., `Entrez.esearch`, `Entrez.efetch`). Credentials (`NCBI_EMAIL`, `NCBI_API_KEY`) sourced from environment variables. Helper for API calls.
  - [X] Add internal data cleaning (`_recursive_clean`) and parsing (`_parse_pubmed_*` helpers) for Entrez results.
  - [X] Call refactored `_map_pubmed_to_search_result` (which uses new parsing helpers) for each cleaned record.
  - [X] Use `SearchResultRepository.add_all` (or equivalent from Story 1.3, ensuring it accepts a session) to store `models.SearchResult` instances.
  - [X] Implement error handling for API and repository calls.
  - [X] Create and pass integration test `test_search_pubmed_and_store_results`.
- [X] **Task 1.2.3: Refactor `update_search_result` Method in `SearchService`**
  - [X] Change signature to: `(self, result_id: uuid.UUID, update_data: schemas.SearchResultUpdate) -> models.SearchResult`.
  - [X] Implement internal session management using `self.session_factory.begin()`.
  - [X] Fetch `models.SearchResult` using `SearchResultRepository.get_by_id`.
  - [X] Apply updates from `schemas.SearchResultUpdate` to the fetched model instance.
  - [X] Save using `SearchResultRepository.update`, including `session.refresh()`.
- [X] **Task 1.2.4: Remove `add_api_search_results` Method from `SearchService`**
- [X] **Task 1.2.5: Review and Correct Internal Mapping Methods in `SearchService`**
  - [X] Ensure `_map_pubmed_to_search_result` has correct type hint `api_record: dict[str, Any]`.
  - [X] Verify mapping logic correctly populates `models.SearchResult`, ensuring `year` is `str | None` and other fields are robust.
  - [X] Ensure `_map_scopus_to_search_result` type hint `api_record: dict[str, Any]`.
- [X] **Task 1.2.6: Implement/Verify Comprehensive Error Handling in `SearchService`**
  - [X] Ensured `try/except` blocks for API calls and repository interactions, raising appropriate `ServiceError` or specific repository errors.
- [X] **Task 1.2.7: Write/Update Unit Tests for `SearchService` Methods**
  - [X] Covered `search_pubmed_and_store_results` and its parsing/mapping helpers with unit tests using `pytest-mock`.
- [X] **Task 1.2.8: Run Linter and Fix Errors for `SearchService` in `services.py`**
- [X] **Task 1.2.9: Refactor `ReviewService` Public Methods for Internal Session Management**
  - [X] `ReviewService.__init__` confirmed to correctly use `BaseService` for `self.session_factory`.
  - [X] For `create_review`: Verified internal session using `self.session_factory.begin()`, passed session to repo.
  - [X] For `get_review`: Verified internal session using `self.session_factory.begin()`, passed session to repo.
  - [X] For `get_all_reviews`: Verified internal session using `self.session_factory.begin()`, passed session to repo.
  - [X] For `update_review`: Verified internal session using `self.session_factory.begin()`, passed session to repo.
  - [X] For `delete_review`: Verified internal session using `self.session_factory.begin()`, passed session to repo.
- [X] **Task 1.2.10: Write/Update Unit Tests for `ReviewService` Methods**
  - [X] Ensured tests reflect internal session management and schema usage; all unit tests for `ReviewService` are passing.
- [X] **Task 1.2.11: Verify `src/sr_assistant/app/pages/protocol.py` Interactions with `ReviewService`**
  - [X] Review `build_review_model_from_pico` in `protocol.py` to ensure its output data structure is compatible with the `schemas.SystematicReviewCreate` Pydantic schema expected by the refactored `ReviewService.create_review` method.
  - [X] Review `persist_review` function in `protocol.py`. Ensure it calls the refactored `ReviewService.update_review` (passing a `schemas.SystematicReviewUpdate` Pydantic object) or `ReviewService.create_review` (passing `schemas.SystematicReviewCreate`), and that it no longer performs direct model manipulation and session commits after service calls.
  - [X] Confirm `protocol.py` no longer passes session objects to any `ReviewService` methods.
- [X] **Task 1.2.12: Final Linter Pass on `services.py` and `protocol.py`**

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** 
    - **Task 1.2.1 & 1.2.2 Learnings:**
        - **Session Management:** Standardized on `with self.session_factory.begin() as session:` for service methods requiring database interaction. This pattern, as documented in `database.py`, ensures automatic transaction commit on success and rollback on error, simplifying session handling within service methods. The `session` parameter was removed from the public interface of affected methods.
        - **PubMed Integration & Parsing:**
            - Initial attempts to parse `Bio.Entrez.read()` output directly led to type errors. The approach was refactored to introduce a `_recursive_clean` helper within `SearchService` to convert BioPython parser objects into standard Python types.
            - `_map_pubmed_to_search_result` was further refactored to use several new private helper methods (`_parse_pubmed_ids`, `_parse_pubmed_title_abstract`, etc.), each responsible for extracting specific fields from the *cleaned* dictionary. This promotes modularity and testability.
            - Credentials for PubMed (`NCBI_EMAIL`, `NCBI_API_KEY`) are now sourced from environment variables within `search_pubmed_and_store_results`, removing them as method parameters.
            - Ensured MeSH headings are parsed and included in `source_metadata`.
        - **Integration Testing (`conftest.py` usage):**
            - Integration tests for services utilize fixtures from `tests/conftest.py` (`db_session`, `clean_db`).
            - A test-specific `sessionmaker` (e.g., `search_service_test_session_factory` fixture) is created, bound to the `db_session`'s engine, and injected into the service instance for testing.
            - Test data (e.g., `SystematicReview` instances) is created directly using the `db_session` fixture. The `test_review_with_criteria` fixture was created to provide realistic review data, including PICO fields and derived inclusion criteria.
            - Assertions verify service method return values and database state. The integration test for `search_pubmed_and_store_results` is passing.
    - **Task 1.2.3 (Update SearchResult):**
        - `SearchService.update_search_result` refactored to accept `result_id: UUID` and `update_data: schemas.SearchResultUpdate`.
        - Uses `self.session_factory.begin()` for session management.
        - Updates are applied using `model_dump(exclude_unset=True)` from the schema and then `setattr` on the fetched model.
        - The repository's `update` method (which flushes the specific record) is called, followed by `session.refresh()` in the service to ensure the returned object includes any server-side updates (e.g., `updated_at` timestamps). This clarified the correct sequence of `flush` (in repo) and `refresh` (in service) within a transactional `begin()` block.
    - **Task 1.2.7 & 1.2.10 (Unit Testing Services):**
        - Unit tests were added for `SearchService`'s new PubMed parsing helpers, the main mapping coordinator, and the public `search_pubmed_and_store_results` method (using `pytest-mock`'s `mocker` fixture).
        - Unit tests were added for all public methods of `ReviewService`, mocking the session factory and repository layer. All unit tests for `SearchService` (related to PubMed search) and `ReviewService` are passing.
        - **Key Learning (Mocking Strategy):** Successfully refactored tests to use `pytest-mock`'s `mocker` fixture for patching, resolving earlier issues with `unittest.mock.patch` class decorators and fixture injection.
        - **Key Learning (Model Validation & Defaults):** Addressed `ValidationError`s for Pydantic models by using `.model_dump(exclude_none=True)` on Pydantic schemas before `SQLModel.model_validate()` and by ensuring model fields like `inclusion_criteria` in `SystematicReview` had `default=None` if they were `Optional` and intended to allow omission in input dicts.
        - **Cross-cutting Issue (`research_question` typo):**
            - A typo (`reearch_question`) in the `SystematicReview` model was corrected to `research_question` in `src/sr_assistant/core/models.py`.
            - All dependent code in services (`ReviewService`), page logic (`protocol.py`), and unit tests (`test_services.py`, `test_protocol.py`, `test_repositories.py`) was updated to use the correct `research_question` spelling. This resolved numerous `AttributeError` and `ValidationError` failures in tests and ensured consistency with the database schema.
- **Change Log:**
  - Initial Draft 