# Story 1.1: Ensure `SearchResult` Model Consistency and Correct Service Usage in `search.py`

**Status:** Draft

## Goal & Context

**User Story:** As a developer, I want `search.py` to correctly interact with the refactored `SearchService` and consistently use the `schemas.SearchResultRead` Pydantic schema (derived from the `models.SearchResult` model) for displaying and handling PubMed search results, so that data representation is accurate, service layer encapsulation is respected, and the UI aligns with the intended generic search architecture.

**Context:** This story is a critical part of Epic 1 ("Search and Service Layer Stabilization"). It focuses on ensuring the main search UI page (`search.py`) correctly utilizes the refactored `SearchService` (Story 1.2) and the standardized `schemas.SearchResultRead` Pydantic schema (Story 1.5) for all PubMed search operations and data display. This alignment is essential for a stable user experience and adherence to the project's architectural pattern where UI pages interact with services, which in turn handle business logic and data persistence. Story 1.2 (SearchService refactor) and Story 1.5 (SearchResult Pydantic schemas) are completed prerequisites.

## Detailed Requirements

(Copied from `docs/epic1-recovery-search-stabilization.md#Story-1.1`)

1.  **Service Interaction:**
    *   All PubMed search operations initiated from `search.py` MUST call the `SearchService.search_pubmed_and_store_results` method.
    *   `search.py` MUST NOT pass any `session` objects to `SearchService` methods.
    *   Any logic for directly calling PubMed APIs or managing raw API records within `search.py` MUST be removed (this is now `SearchService`'s responsibility).
2.  **Data Handling & Display:**
    *   `search.py` MUST expect a sequence of `schemas.SearchResultRead` objects directly from `SearchService.search_pubmed_and_store_results`. The service layer is responsible for this conversion.
    *   All UI components in `search.py` (e.g., Streamlit tables, detail display elements) that show search result information MUST be updated to bind to the fields of `schemas.SearchResultRead` (e.g., `source_id`, `source_db`, `title`, `abstract`, `year` as string, etc.).
    *   Ensure any actions taken on search results (e.g., selection for screening, displaying details) correctly reference and use data from these `schemas.SearchResultRead` Pydantic objects.
3.  **Error Handling:**
    *   Update error handling in `search.py` to appropriately manage and display errors that might be raised by the refactored `SearchService`.

## Acceptance Criteria (ACs)

(Copied from `docs/epic1-recovery-search-stabilization.md#Story-1.1`)

- AC1: `search.py` calls `SearchService.search_pubmed_and_store_results` for PubMed searches and does not pass session objects.
- AC2: PubMed search results displayed in the `search.py` UI correctly use fields from `schemas.SearchResultRead` Pydantic objects.
- AC3: All direct PubMed API interaction logic is removed from `search.py`.
- AC4: All references to PubMed-specific identifiers (like `pmid`) in `search.py` are handled via `SearchResultRead.source_id` (where `source_db` is 'PubMed').
- AC5: Error handling for service calls is implemented in `search.py`.

## Technical Implementation Context

**Guidance:** Use the following details for implementation. Developer agent is expected to follow project standards in `docs/coding-standards.md` and understand the project structure in `docs/project-structure.md`. Only story-specific details are included below.

- **Relevant Files:**
  - Files to Modify: `src/sr_assistant/app/pages/search.py`

- **Key Technologies:**
  - Streamlit (for UI components and page logic)
  - Pydantic (for `schemas.SearchResultRead`)

- **API Interactions / SDK Usage:**
  - `SearchService.search_pubmed_and_store_results` (from `src/sr_assistant/app/services.py`)
    - Expected Input: `review_id: uuid.UUID`, `query: str`, `max_results: int`
    - Expected Output: `Sequence[schemas.SearchResultRead]` (The service layer handles mapping from `models.SearchResult` to this Pydantic schema).

- **UI/UX Notes:**
  - Ensure Streamlit components like `st.dataframe`, `st.expander`, `st.button`, etc., are correctly updated to source data from `schemas.SearchResultRead` object attributes.
  - Error messages from `SearchService` should be displayed to the user in a clear and user-friendly way (e.g., using `st.error`).

- **Data Structures:**
  - `schemas.SearchResultRead` (from `src/sr_assistant/core/schemas.py` - definition confirmed in Story 1.5) - This is the type expected from the service.
    - Key fields for display: `id`, `source_db`, `source_id`, `title`, `abstract`, `year`, `authors`, `journal`.
  - ~~`models.SearchResult` (from `src/sr_assistant/core/models.py`) - as returned by `SearchService`.~~ (Strikethrough or remove this line as service now returns schema)

- **Environment Variables:**
  - None specific to `search.py` for this story, but `SearchService` relies on `NCBI_API_KEY` and `NCBI_EMAIL`.

- **Coding Standards Notes:**
  - Follow standards in `docs/coding-standards.md`.
  - Ensure `SearchService` is instantiated correctly in `search.py` (it expects a `session_factory` but uses a default if not provided; `search.py` should likely use the default instantiation).
  - ~~When converting `models.SearchResult` to `schemas.SearchResultRead` for display, use `schemas.SearchResultRead.model_validate(search_result_model_instance)`.~~ (This conversion now happens in the service layer).

- **Project Structure Alignment:**
  - All changes occur within `src/sr_assistant/app/pages/search.py`.

## Testing Requirements

**Guidance:** Verify implementation against the ACs. Follow general testing approach in `docs/testing-strategy.md`.

- **Unit Tests:** (Focus on `search.py` logic, mocking `SearchService`)
  - Test that the `search_pubmed_and_store_results` method of a mocked `SearchService` is called with correct parameters when a search is initiated.
  - Test that the UI correctly displays data from a list of mock `schemas.SearchResultRead` objects.
  - Test error handling: if `SearchService` raises an exception, verify `st.error` is called with an appropriate message.
- **Integration Tests:** (Existing or to be updated in conjunction with service tests)
  - Integration tests for `SearchService` (Story 1.2) cover the service's correct functioning.
  - Manual E2E testing of the search page workflow after changes will be important.
- **Manual/CLI Verification:**
  - Run the Streamlit app (`make run`).
  - Navigate to the "Search" page.
  - Perform a PubMed search with a known query.
  - Verify results are displayed correctly, using fields from `schemas.SearchResultRead`.
  - Verify no `session` objects are passed to the service.
  - Verify no direct PubMed API calls are made from `search.py`.

## Tasks / Subtasks

(Derived from `docs/epic1-recovery-search-stabilization.md#Story-1.1` and expanded)

- [ ] Task 1.1.1: Analyze `search.py` for current PubMed search initiation logic, data handling, and display of search results. Identify all sections making direct PubMed API calls or managing raw API data.
- [ ] Task 1.1.2: Refactor search initiation logic in `search.py`:
    - Instantiate `SearchService` (likely using its default `session_factory`).
    - Modify the PubMed search function/callback in `search.py` to call `search_service_instance.search_pubmed_and_store_results(review_id, query, max_results)`.
    - Ensure `review_id` is correctly obtained from the current context (e.g., selected review in Streamlit session state).
    - Remove any direct PubMed API calls (e.g., `Entrez.esearch`, `Entrez.efetch`) from `search.py`.
    - Remove any session object creation or passing from `search.py` to the service.
- [ ] Task 1.1.3: Update data handling logic in `search.py`:
    - The call to `search_service_instance.search_pubmed_and_store_results` will return a `Sequence[models.SearchResult]`.
    - Implement logic to convert each `models.SearchResult` object in the sequence to a `schemas.SearchResultRead` Pydantic object (e.g., using a loop and `schemas.SearchResultRead.model_validate(model_instance)`).
    - Store or use this list of `schemas.SearchResultRead` objects for display.
- [ ] Task 1.1.4: Update Streamlit UI components in `search.py` to display data from `schemas.SearchResultRead` objects:
    - If using `st.dataframe`, ensure columns match `schemas.SearchResultRead` field names or are derived correctly.
    - If displaying details in `st.expander` or other elements, update them to access attributes from `schemas.SearchResultRead` objects (e.g., `result.title`, `result.source_id`).
    - Ensure that any UI actions (e.g., selecting a result for screening) use the `id` or other relevant fields from the `schemas.SearchResultRead` object.
- [ ] Task 1.1.5: Implement or update error display logic in `search.py`:
    - Wrap the call to `SearchService.search_pubmed_and_store_results` in a `try-except` block.
    - Catch potential exceptions that `SearchService` might raise (e.g., a custom `ServiceError` or more general exceptions if specific ones aren't defined).
    - Use `st.error()` to display a user-friendly error message.
- [ ] Task 1.1.6: Review and ensure that all references to PubMed-specific identifiers (like `pmid`) in `search.py` are now handled via `SearchResultRead.source_id` and a check that `SearchResultRead.source_db == SearchDatabaseSource.PUBMED`.
- [ ] Task 1.1.7: Write/update unit tests for `search.py` focusing on mocking `SearchService` calls, verifying UI data binding (conceptually, by checking how data is passed to `st` functions), and error handling.

## Story Wrap Up (Agent Populates After Execution)

- **Agent Model Used:** `<Agent Model Name/Version>`
- **Completion Notes:** {Any notes about implementation choices, difficulties, or follow-up needed}
- **Change Log:**
  - Initial Draft by Technical Scrum Master Agent 