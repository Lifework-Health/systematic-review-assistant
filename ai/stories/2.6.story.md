# Story 2.6: Refactor Screening Workflow for Service Layer Integration & UI Error Resolution

**Status:** Draft

## Goal & Context

**User Story:** As a developer, I need the abstract screening process to be managed by the `ScreeningService`, which will correctly invoke the screening agent and handle data persistence, and the `screen_abstracts.py` UI page to be updated to use this service. This will ensure robust data handling, adherence to architecture, and resolution of the current `ValidationError` on the screening page.

**Context:**
This story focuses on architecturally aligning the abstract screening workflow. The core screening agent (`screen_abstracts_chain` and `screen_abstracts_batch` in `src/sr_assistant/app/agents/screening_agents.py`) is now considered functional (returning `ScreeningResult` instances correctly after LangChain/Pydantic versions were pinned to resolve a prior regression).

The current issue (as of latest testing) is a `ValidationError` on the `screen_abstracts.py` page: `1 validation error for SearchResultRead conservative_result_id Object has no attribute 'conservative_result_id'`. This occurs because the UI page attempts to use `schemas.SearchResultRead` instances (populated in `st.session_state.search_results` by the search page) directly with the `screen_abstracts_batch` agent function, which expects to modify mutable `models.SearchResult` instances (e.g., to set `conservative_result_id`).

This story will resolve this by ensuring the `ScreeningService` orchestrates the screening: it will fetch fresh `models.SearchResult` instances, invoke the screening agent with these models, and persist results. The `screen_abstracts.py` page will be refactored to call this service, adhering to the UI -> Service -> Repository pattern and fixing the `ValidationError`.

## Detailed Requirements

1. **`ScreeningService` - New Method for Batch Screening Orchestration:**
    *   Implement a new method in `ScreeningService` (e.g., `perform_batch_abstract_screening(review_id: UUID, search_result_ids_to_screen: list[UUID]) -> list[ScreenAbstractResultTuple]`).
    *   This service method will:
        *   Fetch the `models.SystematicReview` instance using `ReviewService` or `SystematicReviewRepository`.
        *   Fetch the required `list[models.SearchResult]` (SQLModel instances) from the database using `SearchResultRepository` based on `search_result_ids_to_screen`.
        *   Invoke `screen_abstracts_batch` (from `screening_agents.py`) with the fetched `models.SearchResult` list and the review. `screen_abstracts_batch` is assumed to be correctly returning `ScreenAbstractResultTuple` containing `ScreeningResult` or `ScreeningError` and modified `models.SearchResult`.
        *   For each successful screening tuple returned by the agent:
            * Persist the `ScreeningResult` data (conservative and comprehensive strategies) by creating `models.ScreenAbstractResult` records. This involves using `ScreenAbstractResultRepository` and potentially a `schemas.ScreeningResultCreate` DTO.
            * Update the original `models.SearchResult` instance in the database (via `SearchResultRepository.update()`) with its newly acquired `conservative_result_id` and `comprehensive_result_id`.
        *   Handle and log any `ScreeningError` instances returned by the agent.
        *   Return appropriate data to the UI (e.g., the list of `ScreenAbstractResultTuple` or a summary of outcomes).
    *   This service method must manage its own database session and transactions.

2. **Refactor `src/sr_assistant/app/pages/screen_abstracts.py` UI Page:**
    * Modify the page to call the new `ScreeningService.perform_batch_abstract_screening()` method.
    * The list of items to screen should be passed to the service, likely as a list of `search_result_id`s derived from `st.session_state.search_results`.
    * Remove direct calls to `screen_abstracts_batch` and direct repository calls for loading `SearchResult` instances *for the purpose of passing them to the screening agent*.
    * The page should use the data returned by the `ScreeningService` to update its display and `st.session_state` (e.g., `st.session_state.screen_abstracts_results`, `screen_abstracts_conflicts`, metrics).
    * This refactoring will resolve the `ValidationError` by ensuring that attribute modifications like `conservative_result_id` are performed on `models.SearchResult` instances fetched and managed within the service layer, not on `schemas.SearchResultRead` instances from the UI's session state.

3. **Refine Screening Agent API (If Necessary):**
    * Review the API of `screen_abstracts_batch` and `make_screen_abstracts_chain_input`. If the `ScreeningService` integration reveals further needs for simplification (e.g., how `RunnableConfig` is handled, or if the agent should return data in a more service-friendly format), make those refinements within `screening_agents.py`. The goal is a clean interface for the service.

## Acceptance Criteria (ACs)

* AC1: A new method in `ScreeningService` successfully orchestrates the batch abstract screening: it fetches `models.SearchResult` instances, calls `screen_abstracts_batch` with these mutable models, and correctly persists all screening decisions (`models.ScreenAbstractResult`) and updates to `models.SearchResult` (linkage IDs like `conservative_result_id`).
* AC2: `src/sr_assistant/app/pages/screen_abstracts.py` is refactored to use the new `ScreeningService` method for initiating and processing abstract screening.
* AC3: The `ValidationError: 1 validation error for SearchResultRead conservative_result_id Object has no attribute 'conservative_result_id'` on the screening page is resolved.
* AC4: The screening agent (`screen_abstracts_batch`) correctly receives `models.SearchResult` instances and can modify them as intended.
* AC5: Unit tests for the new `ScreeningService` method(s) cover its full logic (data fetching, agent invocation, data persistence) using mocks.
* AC6: Unit tests for `screen_abstracts.py` are updated to verify its correct interaction with the (mocked) `ScreeningService`.
* AC7: Unit tests for `screening_agents.py` confirm `screen_abstracts_batch` processes `models.SearchResult` correctly.
* AC8: All linter errors in modified files are resolved.

## Technical Implementation Context

*   **Primary Files for Modification:**
    * `src/sr_assistant/app/services.py` (Implement new `ScreeningService` method)
    * `src/sr_assistant/app/pages/screen_abstracts.py` (Refactor to use `ScreeningService`)
    * `src/sr_assistant/app/agents/screening_agents.py` (Potential API refinements for `screen_abstracts_batch`)
*   **Supporting Files (Verify/Ensure Methods Exist):**
    * `src/sr_assistant/core/repositories.py` (`SearchResultRepository`, `ScreenAbstractResultRepository`)
    * `src/sr_assistant/core/schemas.py` (e.g., `ScreeningResultCreate` for service layer use)
*   **Reference for Working Agent Logic (Post-LangChain Pinning):** The current `src/sr_assistant/app/agents/screening_agents.py` is assumed to be functional in terms of its LLM calls and `ScreeningResult` production from its callback, due to version pinning.

## Tasks / Subtasks

1. **Design `ScreeningService.perform_batch_abstract_screening` Method:**
    * Define precise input (e.g., `review_id`, `list_of_search_result_ids`) and output (e.g., `list[ScreenAbstractResultTuple]`).
2. **Implement `ScreeningService.perform_batch_abstract_screening`:**
    *   Fetch `models.SystematicReview`.
    *   Fetch `list[models.SearchResult]` based on input IDs.
    *   Call `screen_abstracts_batch` from `screening_agents.py`.
    *   Loop through results from `screen_abstracts_batch`:
        * Create `schemas.ScreeningResultCreate` DTOs for conservative and comprehensive results.
        * Call `ScreenAbstractResultRepository.add()` (or a service method if preferred) to save `ScreenAbstractResult` records.
        * Call `SearchResultRepository.update()` to save changes to `models.SearchResult` instances (e.g., `conservative_result_id`).
    *   Implement transaction management (`with session_factory.begin():`).
    *   Implement error handling.
3. **Refactor `src/sr_assistant/app/pages/screen_abstracts.py`:**
    * Remove direct data loading for screening (keep for initial display if needed, but ensure models passed to service are fresh or by ID).
    * Replace direct call to `screen_abstracts_batch` with a call to the new `ScreeningService` method.
    * Update UI logic to use the results returned by the service.
4. **Refine Agent API (If Needed):**
    * Assess if `screen_abstracts_batch` or `make_screen_abstracts_chain_input` need changes for cleaner service integration.
5. **Write/Update Unit Tests:**
    * For the new `ScreeningService` method (mocking agent and repositories).
    * For `screen_abstracts.py` (mocking `ScreeningService`).
    * Ensure existing tests for `screening_agents.py` are still relevant and passing if its API is slightly adjusted.
6. **Manual E2E Testing:** Verify the screening workflow on the UI.
7. **Linting & Code Review.**
