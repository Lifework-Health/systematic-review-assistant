# Story 2.6: Refactor Screening Agent for Service Layer Integration

**Status:** Draft

## Goal & Context

**User Story:** As a developer, I need the abstract screening agent to be refactored for cleaner integration with the `ScreeningService`, ensuring robust data handling and error reporting, so that the service layer can reliably manage the screening process.

**Context:** This story follows the implementation of the core screening agent (Story 2.0 - assuming this was the initial implementation) and the resolver agent. It focuses on making the screening agent (`screen_abstracts_chain` and its related components in `src/sr_assistant/app/agents/screening_agents.py`) more modular and easier to invoke and manage from the `ScreeningService`. This is crucial for centralizing business logic in the service layer and abstracting the complexities of the LangChain agent from the UI pages and other services.

**CRITICAL REGRESSION & CONTEXT FOR FIXING SCREENING AGENT (Discovered during review of Story 1.4 completion and subsequent issues):**

A regression was introduced (likely in commit `b8d9509`, "refactor: streamline screening agent logic and improve error handling") that broke the abstract screening process. Currently, the `screen_abstracts_chain_on_end_cb` callback in `src/sr_assistant/app/agents/screening_agents.py` fails to correctly transform the LLM's raw `ScreeningResponse` into the enriched `schemas.ScreeningResult` object within the output structure returned by `screen_abstracts_chain.batch()`.

Consequently, the `screen_abstracts_batch` function receives `ScreeningResponse` objects instead of `ScreeningResult` objects, leading it to incorrectly treat these as errors. This is confirmed by `app.log` entries showing `ScreeningError` with a `ScreeningResponse` as its `error` attribute and the message "Chain on_end failed, this is nested chain's screening output".

The file **`src/sr_assistant/app/agents/screening_agents_old_working.py`** contains a version of the screening agent where this transformation and the overall screening batching logic were functioning correctly. This file should be used as the primary reference for restoring the correct behavior. The primary point of failure in the current version appears to be within the `screen_abstracts_chain_on_end_cb`, particularly around the extraction of metadata like `resp_metadata`, `invocation_params`, and `model_name` (evidenced by a "FIXME: these don't work" comment introduced in `b8d9509`). If this metadata extraction fails or the callback errors internally before successfully updating `run_obj.outputs[output_key]` with the `ScreeningResult`, the regression occurs.

## Detailed Requirements

(Partially from `docs/epic2-recovery-resolver-implementation.md#Story-2.6` and updated with regression fix)

1. **Restore Callback Integrity (TOP PRIORITY FIX FOR REGRESSION):**
    *   Thoroughly compare the `screen_abstracts_chain_on_end_cb` in the current `src/sr_assistant/app/agents/screening_agents.py` with the version from **`src/sr_assistant/app/agents/screening_agents_old_working.py`**.
    *   Identify and revert/fix the specific changes (likely from commit `b8d9509`) related to `resp_metadata`, `invocation_params`, and `model_name` extraction that broke the reliable creation and propagation of `ScreeningResult` objects.
    *   Ensure the callback robustly populates all fields of `schemas.ScreeningResult` (including `id`, `review_id`, `search_result_id`, `trace_id`, `model_name`, `start_time`, `end_time`, `response_metadata`, `screening_strategy`) by correctly parsing the `Run` object and its children (`cr`, `ccr`), using the logic from the working reference file.
    *   Verify that `run_obj.outputs[output_key] = screening_result` is effectively executed for each strategy and that `screen_abstracts_chain.batch()` returns a list where each item is a dictionary: `{"conservative": <ScreeningResult_instance>, "comprehensive": <ScreeningResult_instance>}`.

2. **Confirm `screen_abstracts_batch` Processing:**
    *   Once Task 1 is complete, confirm that the existing logic in `screen_abstracts_batch` correctly processes these dictionaries and produces `ScreenAbstractResultTuple` instances with valid `ScreeningResult` objects (or `ScreeningError` only for genuine LLM/chain failures, not type mismatches). The logic in `screening_agents_old_working.py` should serve as a reference.

3. **Refactor for Service Layer Integration (Original Story 2.6 Goal - Proceed after regression is fixed):**
    *   Define a clear, stable interface (input parameters and return type) for invoking the batch screening process.
    *   The primary function (e.g., `screen_abstracts_batch` or a new wrapper around it) should be easily callable from `ScreeningService`, accepting parameters like `list[models.SearchResult]` and `models.SystematicReview`.
    *   The return type should be robust, likely `list[ScreenAbstractResultTuple]`, where `ScreenAbstractResultTuple` clearly distinguishes between successful `ScreeningResult` and `ScreeningError` for each reviewer strategy.
    *   Encapsulate any complex LangChain-specific configurations (like `RunnableConfig` setup within `make_screen_abstracts_chain_input`) inside the agent module, exposing a simpler API to the service.
    *   Improve error propagation: Ensure that if `screen_abstracts_chain.batch()` returns exceptions or `ScreeningError` objects, these are clearly packaged and returned by `screen_abstracts_batch` for the service layer to handle.

## Acceptance Criteria (ACs)

(Updated to include regression fix)

*   AC1: The `screen_abstracts_chain_on_end_cb` callback in `screening_agents.py` reliably transforms raw LLM outputs (`ScreeningResponse`) into enriched `schemas.ScreeningResult` objects, including all necessary metadata, aligning with the working implementation in **`src/sr_assistant/app/agents/screening_agents_old_working.py`**.
*   AC2: The `screen_abstracts_batch` function correctly processes the output of `screen_abstracts_chain.batch()`, receiving dictionary structures containing `ScreeningResult` instances for each reviewer strategy, and correctly forms `ScreenAbstractResultTuple`s, aligning with **`src/sr_assistant/app/agents/screening_agents_old_working.py`**.
*   AC3: The refactored screening agent (e.g., `screen_abstracts_batch` or a wrapper) has a clear and stable API (inputs, outputs) suitable for invocation by `ScreeningService`.
*   AC4: The screening agent correctly handles and propagates errors for individual screening failures within a batch, allowing `ScreeningService` to identify and manage them.
*   AC5: Unit tests for `screening_agents.py` are updated or created to verify the corrected callback logic, the behavior of `screen_abstracts_batch` with correctly formed inputs, and the new service-callable interface.
*   AC6: All linter errors in `screening_agents.py` are resolved.
*   AC7: (If applicable and decided by dev) The `ScreeningService` is updated to call this refactored screening agent (this might be deferred to a subsequent focused service integration story if 2.6 is only about the agent's API).

## Technical Implementation Context

*   **Relevant Files:**
    *   `src/sr_assistant/app/agents/screening_agents.py` (Primary focus)
    *   `src/sr_assistant/core/schemas.py` (If `ScreeningResult` or related schemas need minor adjustments for consistency)
    *   `tests/unit/app/agents/test_screening_agents.py`
*   **Reference File for Working Logic:** **`src/sr_assistant/app/agents/screening_agents_old_working.py`**

## Tasks / Subtasks

1. **Analyze Regression (Done in previous interaction):** Detailed analysis of logs and git history identified the likely point of failure in `screen_abstracts_chain_on_end_cb` (metadata extraction) introduced in commit `b8d9509`.
2. **Restore Callback Integrity (AC1, AC2):**
    *   Compare current `screen_abstracts_chain_on_end_cb` with the version from **`src/sr_assistant/app/agents/screening_agents_old_working.py`**.
    *   Fix the metadata (`resp_metadata`, `invocation_params`, `model_name`) extraction logic within the callback, using the working file as a definitive reference.
    *   Ensure robust derivation of `output_key` from `cr.tags`.
    *   Thoroughly test the callback's transformation from `ScreeningResponse` to `ScreeningResult` in isolation if possible, or via the full chain.
3. **Verify `screen_abstracts_batch` (AC2):**
    *   With the callback fixed, ensure `screen_abstracts_batch` correctly receives and processes the expected data structure (list of dicts of `ScreeningResult`), referencing **`src/sr_assistant/app/agents/screening_agents_old_working.py`**.
4. **Refactor Agent API for Service (AC3, AC4):**
    *   Define the clean input/output contract for the service-callable screening function.
    *   Refactor `make_screen_abstracts_chain_input` and `screen_abstracts_batch` as needed to support this.
5. **Update/Create Unit Tests (AC5):**
    *   Write comprehensive unit tests for the corrected callback logic.
    *   Test `screen_abstracts_batch` with various scenarios, including empty batches, batches with errors, and successful batches.
6. **Linting (AC6):** Resolve any linter issues.
7. **Code Review & Story Wrap-up.**
